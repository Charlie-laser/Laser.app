<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Database App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; display: flex; margin: 0; height: 100vh; overflow: hidden; }
    #menu { width: 220px; background: #f4f4f4; padding: 10px; border-right: 1px solid #ccc; height: 100vh; position: fixed; left: 0; top: 0; overflow-y: auto; }
    #menu h3 { margin-top: 0; }
    #menu div { padding: 8px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 6px; }
    #menu div:hover { background: #ddd; }
    #content { flex: 1; padding: 20px; margin-left: 240px; height: 100vh; overflow-y: auto; }
    .db-item { padding: 6px; border: 1px solid #ddd; margin: 6px 0; border-radius: 4px; display: flex; align-items: center; justify-content: flex-start; gap: 10px; }
    .db-item:hover { background: #f0f0f0; }
    .db-left { cursor: pointer; flex: 1; }
    .db-menu { cursor: pointer; padding: 4px; color: #888; }
    .db-menu:hover { color: #000; }
    .menu-popup { position: absolute; background: white; border: 1px solid #ccc; border-radius: 4px; display: none; z-index: 1000; box-shadow: 0 2px 6px rgba(0,0,0,0.2); min-width: 150px; }
    .menu-popup div { padding: 6px 12px; cursor: pointer; }
    .menu-popup div:hover { background: #eee; }
    #errorBox { color: red; margin: 10px 0; display: none; }
    .loading { color: blue; font-style: italic; margin: 10px 0; }
    .success { color: green; margin: 10px 0; }
    .progress-container { width: 100%; background: #eee; border-radius: 4px; margin: 10px 0; height: 20px; }
    .progress-bar { height: 100%; background: green; width: 0%; text-align: center; color: white; font-size: 12px; border-radius: 4px; }

    table { border-collapse: collapse; width: 100%; font-size: 14px; }
    thead th { position: sticky; top: 0; background: #f0f0f0; border: 1px solid #ccc; padding: 6px; text-align: left; z-index: 1; }
    tbody td { border: 1px solid #ddd; padding: 6px; }
    tbody tr:nth-child(even) { background: #fafafa; }
    tbody tr:hover { background: #f1f7ff; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div id="menu">
    <h3>Menu</h3>
    <div onclick="goHome()">üè† Home</div>
    <div onclick="goBack()">‚¨Ö Back</div>
    <div onclick="openDatabases()">üìÇ Databases</div>
    <div onclick="openForms()">üìã Forms</div>
  </div>

  <!-- Content -->
  <div id="content">
    <h2>Welcome</h2>
    <p>Select an option from the menu.</p>
  </div>

  <!-- Popup Menu -->
  <div id="popupMenu" class="menu-popup">
    <div onclick="renameDatabase()">‚úèÔ∏è Rename</div>
    <div onclick="deleteDatabase()">üóë Delete</div>
  </div>

  <script>
    let databases = JSON.parse(localStorage.getItem("databases") || "{}");
    let currentPopupDB = null;
    let historyStack = [];  

    function saveDatabases() {
      localStorage.setItem("databases", JSON.stringify(databases));
    }

    function setContent(html, saveHistory = true) {
      const content = document.getElementById("content");
      if (saveHistory) historyStack.push(content.innerHTML);
      content.innerHTML = html;
    }

    function openDatabases() {
      setContent(`
        <h2>Databases</h2>
        <button onclick="showImportForm()">‚ûï Add Database</button>
        <div id="dbList">
          ${Object.keys(databases).length ? 
            Object.keys(databases).map(db => `
              <div class="db-item">
                <div class="db-menu" onclick="showMenu(event, '${db}')">‚ãÆ</div>
                <div class="db-left" onclick="openDatabase('${db}')">üìä ${db}</div>
              </div>
            `).join("") 
          : "<p>No databases yet.</p>"}
        </div>
      `);
    }

    function showImportForm() {
      setContent(`
        <h2>Add Google Sheet Database</h2>
        <input type="text" id="sheetURL" placeholder="Paste Google Sheet link" style="width:80%">
        <button onclick="importSheet()">Detect Sheets</button>
        <div id="statusBox"></div>
        <div id="errorBox"></div>
        <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      `);
    }

    // Step 1: Detect sheets from Google Sheet
    async function importSheet() {
      const urlInput = document.getElementById("sheetURL").value.trim();
      const statusBox = document.getElementById("statusBox");
      const err = document.getElementById("errorBox");
      err.style.display = "none"; err.textContent = "";
      statusBox.innerHTML = "<p class='loading'>üîç Detecting sheet tabs...</p>";

      let match = urlInput.match(/\/d\/(.*?)\//);
      if (!match) {
        err.textContent = "‚ö†Ô∏è Invalid Google Sheet link!";
        err.style.display = "block"; 
        statusBox.innerHTML = "";
        return;
      }
      let spreadsheetId = match[1];

      try {
        const metaUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?`;
        const response = await fetch(metaUrl);
        const text = await response.text();

        let matches = [...text.matchAll(/"([^"]+)","gid":/g)];
        let sheetNames = matches.map(m => m[1]);

        if (sheetNames.length === 0) throw new Error("No sheets found!");

        if (sheetNames.length === 1) {
          loadSheetCSV(spreadsheetId, sheetNames[0]);
        } else {
          let selectHTML = `
            <h3>Select a Sheet</h3>
            <select id="sheetSelector">
              ${sheetNames.map(name => `<option value="${name}">${name}</option>`).join("")}
            </select>
            <button onclick="confirmSheet('${spreadsheetId}')">Load</button>
          `;
          statusBox.innerHTML = selectHTML;
        }

      } catch (e) {
        console.error(e);
        err.textContent = "‚ùå Failed to fetch sheet metadata!";
        err.style.display = "block";
        statusBox.innerHTML = "";
      }
    }

    function confirmSheet(spreadsheetId) {
      let sheetName = document.getElementById("sheetSelector").value;
      loadSheetCSV(spreadsheetId, sheetName);
    }

    // Step 2: Load CSV with PapaParse
    function loadSheetCSV(spreadsheetId, sheetName) {
      const statusBox = document.getElementById("statusBox");
      const err = document.getElementById("errorBox");
      const progressBar = document.getElementById("progressBar");
      statusBox.innerHTML = `<p class='loading'>‚è≥ Loading <b>${sheetName}</b>...</p>`;
      err.style.display = "none"; err.textContent = "";

      let csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
      let dbName = sheetName + "_" + (Object.keys(databases).length + 1);
      let loadedRows = 0;

      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        worker: true,
        chunkSize: 5000,
        chunk: function(results) {
          if (!databases[dbName]) {
            databases[dbName] = { headers: results.meta.fields.map(h => ({ name: h, type: "Text" })), rows: [] };
          }
          databases[dbName].rows.push(...results.data.map(row => results.meta.fields.map(h => row[h] || "")));

          loadedRows += results.data.length;
          progressBar.style.width = "100%";
          progressBar.textContent = loadedRows + " rows";
        },
        complete: function() {
          saveDatabases();
          statusBox.innerHTML = `<p class='success'>‚úÖ Loaded ${loadedRows} rows from <b>${sheetName}</b></p>`;
          openDatabases();
        },
        error: function() {
          err.textContent = "‚ùå Failed to parse CSV!";
          err.style.display = "block";
          statusBox.innerHTML = "";
        }
      });
    }

    function openDatabase(dbName, page = 1) {
      const db = databases[dbName];
      const rowsPerPage = 100;
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const totalPages = Math.ceil(db.rows.length / rowsPerPage);

      let tableHTML = `
        <div style="overflow-x:auto; max-height:70vh; border:1px solid #ccc; border-radius:4px;">
          <table>
            <thead><tr>${db.headers.map(h => `<th>${h.name}</th>`).join("")}</tr></thead>
            <tbody>
              ${db.rows.slice(start, end).map(row => `<tr>${row.map(cell => `<td>${cell || ""}</td>`).join("")}</tr>`).join("")}
            </tbody>
          </table>
        </div>
        <div style="margin-top:10px; text-align:center;">
          <button onclick="openDatabase('${dbName}', ${page - 1})" ${page === 1 ? "disabled" : ""}>‚¨Ö Prev</button>
          <span> Page ${page} of ${totalPages} </span>
          <button onclick="openDatabase('${dbName}', ${page + 1})" ${page === totalPages ? "disabled" : ""}>Next ‚û°</button>
        </div>
      `;
      setContent(`<h2>${dbName}</h2>${tableHTML}`, false);
    }

    function goHome() { setContent("<h2>Welcome</h2><p>Select an option from the menu.</p>"); }
    function goBack() { if (historyStack.length > 0) document.getElementById("content").innerHTML = historyStack.pop(); }
    function openForms() { setContent("<h2>Forms</h2><p>Forms functionality will go here.</p>"); }

    function showMenu(e, dbName) {
      e.stopPropagation();
      currentPopupDB = dbName;
      const menu = document.getElementById("popupMenu");
      menu.style.display = "block";
      const rect = e.target.getBoundingClientRect();
      menu.style.left = rect.left + "px";
      menu.style.top = rect.bottom + "px";
    }
    document.addEventListener("click", () => { document.getElementById("popupMenu").style.display = "none"; });

    function renameDatabase() {
      const newName = prompt("Enter new name:", currentPopupDB);
      if (newName && !databases[newName]) {
        databases[newName] = databases[currentPopupDB];
        delete databases[currentPopupDB];
        saveDatabases();
        openDatabases();
      }
      document.getElementById("popupMenu").style.display = "none";
    }

    function deleteDatabase() {
      if (confirm("Delete database '" + currentPopupDB + "'?")) {
        delete databases[currentPopupDB];
        saveDatabases();
        openDatabases();
      }
      document.getElementById("popupMenu").style.display = "none";
    }
  </script>
</body>
</html>

async function importSheet() {
  const urlInput = document.getElementById("sheetURL").value.trim();
  const statusBox = document.getElementById("statusBox");
  const err = document.getElementById("errorBox");
  const progressBar = document.getElementById("progressBar");
  err.style.display = "none"; err.textContent = "";
  statusBox.innerHTML = "<p class='loading'>⏳ Loading data from Google Sheet...</p>";

  // Extract spreadsheetId and gid
  let match = urlInput.match(/\/d\/(.*?)\//);
  if (!match) {
    err.textContent = "⚠️ Invalid Google Sheet link!";
    err.style.display = "block"; 
    statusBox.innerHTML = "";
    return;
  }
  let spreadsheetId = match[1];
  let sheetName = "Sheet1"; // default (তুমি চাইলে prompt করতে পারো)
  
  // Force CSV export link
  let csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;

  let dbName = "Sheet_" + (Object.keys(databases).length + 1);
  let loadedRows = 0;

  try {
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      worker: true,
      chunkSize: 5000,
      chunk: function(results) {
        if (!databases[dbName]) {
          databases[dbName] = { headers: results.meta.fields.map(h => ({ name: h, type: "Text" })), rows: [] };
        }
        databases[dbName].rows.push(...results.data.map(row => results.meta.fields.map(h => row[h] || "")));

        loadedRows += results.data.length;
        progressBar.style.width = "100%";
        progressBar.textContent = loadedRows + " rows";
      },
      complete: function() {
        saveDatabases();
        statusBox.innerHTML = "<p class='success'>✅ Database added successfully!</p>";
        openDatabases();
      },
      error: function() {
        err.textContent = "❌ Failed to parse CSV!";
        err.style.display = "block";
        statusBox.innerHTML = "";
      }
    });
  } catch (e) {
    console.error(e);
    err.textContent = "❌ Failed to fetch from Google Sheet!";
    err.style.display = "block";
    statusBox.innerHTML = "";
  }
}

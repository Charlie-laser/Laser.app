<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Database</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 30px; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    .section { margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    .db-list { margin-top: 20px; }
    .db-item { padding: 6px; border: 1px solid #ccc; margin: 4px 0; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Add Database</h1>

  <!-- From CSV -->
  <div class="section">
    <h2>üìÇ From CSV</h2>
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="importCSV()">Upload</button>
    <div id="csvStatus"></div>
  </div>

  <!-- From Google Sheet -->
  <div class="section">
    <h2>üåç From Google Sheet</h2>
    <input type="text" id="sheetUrl" size="80" placeholder="Paste Google Sheet link here">
    <button onclick="importGoogleSheet()">Add</button>
    <div id="sheetStatus"></div>
  </div>

  <!-- Databases List -->
  <h2>üìë Databases</h2>
  <div id="databases" class="db-list"></div>

  <script>
    let databases = {};

    // ===== CSV IMPORT =====
    function importCSV() {
      const fileInput = document.getElementById("csvFile");
      const status = document.getElementById("csvStatus");
      if (!fileInput.files.length) {
        status.innerHTML = "<p class='error'>‚ö† Please select a CSV file.</p>";
        return;
      }
      const file = fileInput.files[0];
      status.textContent = "‚åõ Uploading...";

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const cleanData = results.data.filter(row => Object.keys(row).length > 0);
          if (!cleanData.length) {
            status.innerHTML = "<p class='error'>‚ùå Invalid or empty CSV.</p>";
            return;
          }
          const headers = Object.keys(cleanData[0]);
          let dbName = file.name.replace(".csv", "");
          databases[dbName] = {
            headers: headers.map(h => ({ name: h, type: "Text" })),
            rows: cleanData.map(row => headers.map(h => row[h]))
          };
          status.innerHTML = "<p class='success'>‚úÖ Upload Done!</p>";
          renderDatabases();
        }
      });
    }

    // ===== GOOGLE SHEET IMPORT =====
    async function importGoogleSheet() {
      const url = document.getElementById("sheetUrl").value;
      const status = document.getElementById("sheetStatus");
      status.textContent = "‚åõ Loading from Google Sheet...";

      try {
        let csvUrl = url;
        if (!csvUrl.includes("output=csv")) {
          if (csvUrl.includes("/edit")) {
            csvUrl = csvUrl.replace("/edit", "/export?format=csv");
          } else {
            csvUrl += (csvUrl.includes("?") ? "&" : "?") + "output=csv";
          }
        }

        // ‚úÖ Proxy ‡¶¶‡¶ø‡ßü‡ßá bypass
        const proxyUrl = "https://cors-anywhere.herokuapp.com/";
        const response = await fetch(proxyUrl + csvUrl);

        if (!response.ok) throw new Error("Failed to fetch");
        const csvText = await response.text();

        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            const cleanData = results.data.filter(row => Object.keys(row).length > 0);
            if (!cleanData.length) throw new Error("Empty sheet");

            const headers = Object.keys(cleanData[0]);
            let dbName = "GoogleSheetDB_" + new Date().getTime();
            databases[dbName] = {
              headers: headers.map(h => ({ name: h, type: "Text" })),
              rows: cleanData.map(row => headers.map(h => row[h]))
            };
            status.innerHTML = "<p class='success'>‚úÖ Upload Done!</p>";
            renderDatabases();
          }
        });

      } catch (err) {
        status.innerHTML = "<p class='error'>‚ùå Failed to fetch from Google Sheet!</p>";
        console.error(err);
      }
    }

    // ===== DATABASE RENDER =====
    function renderDatabases() {
      const dbList = document.getElementById("databases");
      dbList.innerHTML = "";
      for (let name in databases) {
        const div = document.createElement("div");
        div.className = "db-item";
        div.textContent = name + " (" + databases[name].rows.length + " rows)";
        dbList.appendChild(div);
      }
    }
  </script>
</body>
</html>
